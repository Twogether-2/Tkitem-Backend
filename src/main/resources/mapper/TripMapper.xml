<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tkitem.backend.domain.trip.mapper.TripMapper">
    <select id="selectTripsByMemberId" resultType="tkitem.backend.domain.trip.vo.Trip">
        SELECT *
        FROM (
            SELECT
                t.trip_id       AS tripId,
                t.tour_package_id AS tourPackageId,
                tour.img_url       AS imgUrl,
                t.title,
                TO_CHAR(NVL(t.departure_date, tp.departure_date), 'YYYY-MM-DD') AS departureDate,
                TO_CHAR(NVL(t.arrival_date,   tp.return_date),   'YYYY-MM-DD')   AS arrivalDate,
                t.type,
                CASE
                    WHEN TRUNC(SYSDATE) &lt; TRUNC(NVL(t.departure_date, tp.departure_date)) THEN 'UPCOMING'
                    WHEN TRUNC(SYSDATE) BETWEEN TRUNC(NVL(t.departure_date, tp.departure_date)) AND TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 'ONGOING'
                    WHEN TRUNC(SYSDATE) &gt; TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 'PAST'
                END AS status
            FROM TRIP t
            LEFT JOIN TOUR_PACKAGE tp ON t.tour_package_id = tp.tour_package_id
            LEFT JOIN TOUR tour ON tp.tour_id = tour.tour_id
            WHERE member_id = #{memberId}
            <if test="cursorDepartureDate != null and cursorTripId != null">
                AND (
                    NVL(t.departure_date, tp.departure_date) &lt; TO_DATE(#{cursorDepartureDate}, 'YYYY-MM-DD')
                    OR (NVL(t.departure_date, tp.departure_date) = TO_DATE(#{cursorDepartureDate}, 'YYYY-MM-DD') AND t.trip_id &lt; #{cursorTripId})
                )
            </if>
            <if test="cursorDepartureDate == null or cursorTripId == null">
                <!-- No additional cursor condition for first page -->
            </if>
            ORDER BY
                CASE
                    WHEN TRUNC(SYSDATE) BETWEEN TRUNC(NVL(t.departure_date, tp.departure_date)) AND TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 1
                    WHEN TRUNC(SYSDATE) &lt; TRUNC(NVL(t.departure_date, tp.departure_date)) THEN 2
                    WHEN TRUNC(SYSDATE) &gt; TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 3
                END,
                CASE
                    WHEN TRUNC(SYSDATE) BETWEEN TRUNC(NVL(t.departure_date, tp.departure_date)) AND TRUNC(NVL(t.arrival_date, tp.return_date)) THEN TRUNC(NVL(t.departure_date, tp.departure_date))
                    WHEN TRUNC(SYSDATE) &lt; TRUNC(NVL(t.departure_date, tp.departure_date)) THEN TRUNC(NVL(t.departure_date, tp.departure_date))
                    WHEN TRUNC(SYSDATE) &gt; TRUNC(NVL(t.arrival_date, tp.return_date)) THEN NULL
                END ASC,
                CASE
                    WHEN TRUNC(SYSDATE) &gt; TRUNC(NVL(t.arrival_date, tp.return_date)) THEN TRUNC(NVL(t.arrival_date, tp.return_date))
                    ELSE NULL
                END DESC,
                t.trip_id DESC
        )
        WHERE ROWNUM &lt;= #{limit}
    </select>
    <select id="selectTripInfoByTripId" resultType="tkitem.backend.domain.trip.vo.Trip">
        SELECT
            t.trip_id       AS tripId,
            tour.img_url       AS imgUrl,
            t.tour_package_id AS tourPackageId,
            t.title,
            t.type,
            TO_CHAR(NVL(t.departure_date, tp.departure_date), 'YYYY-MM-DD') AS departureDate,
            TO_CHAR(NVL(t.arrival_date, tp.return_date),   'YYYY-MM-DD')   AS arrivalDate,
            CASE
                WHEN TRUNC(SYSDATE) &lt; TRUNC(NVL(t.departure_date, tp.departure_date)) THEN 'UPCOMING'
                WHEN TRUNC(SYSDATE) BETWEEN TRUNC(NVL(t.departure_date, tp.departure_date)) AND TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 'ONGOING'
                WHEN TRUNC(SYSDATE) &gt; TRUNC(NVL(t.arrival_date, tp.return_date)) THEN 'PAST'
            END AS status
        FROM TRIP t
        LEFT JOIN TOUR_PACKAGE tp ON t.tour_package_id = tp.tour_package_id
        LEFT JOIN TOUR tour ON tp.tour_id = tour.tour_id
        WHERE t.trip_id = #{tripId}
    </select>
</mapper>
