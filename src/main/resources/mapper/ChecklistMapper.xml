<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tkitem.backend.domain.checklist.mapper.ChecklistMapper">

    <!--trip존재 여부-->
    <select id="existsTrip" parameterType="long" resultType="int">
        SELECT COUNT(1) FROM TRIP WHERE trip_id = #{tripId}
    </select>

    <!--trip데이터 존재 여부 확인-->
    <select id="existsTripWithPackage" parameterType="long" resultType="int">
        SELECT COUNT(1)
        FROM TRIP t
        WHERE t.trip_id = #{tripId}
          AND t.tour_package_id IS NOT NULL
    </select>

    <!--체크리스트 자동 세팅-->
    <update id="generateAiCheckList" statementType="CALLABLE">
        { call P_CHECKLIST_AI_REBUILD(
                #{tripId, mode=IN, jdbcType=NUMERIC},
                #{memberId, mode=IN, jdbcType=NUMERIC}
        ) }
    </update>

    <!--활성 체크리스트 조회-->
    <select id="selectActiveByTrip" parameterType="long"
            resultType="tkitem.backend.domain.checklist.vo.ChecklistItemVo">
        SELECT
            c.checklist_item_id        AS checklistItemId,
            c.trip_id                  AS tripId,
            c.product_category_sub_id  AS productCategorySubId,
            c.item_name                AS itemName,
            c.schedule_date            AS scheduleDate,
            c.score                    AS score,
            c.tier                     AS tier,
            c.notes                    AS notes,
            c.source                   AS source,
            c.is_checked               AS isChecked,
            c.is_purchased             AS isPurchased,
            c.created_at               AS createdAt,
            c.updated_at               AS updatedAt
        FROM CHECKLIST_ITEM c
        WHERE c.trip_id = #{tripId}
          AND c.is_deleted = 'F'
        ORDER BY NVL(c.schedule_date, 0), c.score DESC, c.item_name
    </select>
</mapper>
